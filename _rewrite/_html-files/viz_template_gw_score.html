<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>Title Goes Here</title>
        
        <link rel="stylesheet" type="text/css" href="chump.css">   
        <link rel="stylesheet" type="text/css" href="chump-viz_styles.css">   

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!--<script src="fitty.min.js"></script>-->
        <script src="https://d3js.org/d3.v5.min.js"></script>
       
        <script src="load_database.js"></script>
        
    </head> 
    
    <body> 
        <main>
            <section id="content">
                <div class="divider alt"></div>
                <div class="wrapper dark">
                    <div class="container"></div>
                </div>
                <div class="divider alt"></div>
            </section>
        </main>
    </body> 

    <script>

        function return_comma_formatted_number(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    
        $( function(){
                
            //console.log(database)
            viz_gw_scores()
                
        });

        function viz_gw_scores() {


            // Compile a dataset from the database
            dataset = []

            $.each( database['player_data'], function(idx, val) {

                manager_code = val['manager_info']['fpl_code'] 
                manager_name = val['manager_info']['manager_fullname'] 
                team_name = val['manager_info']['team_name'] 

                fixture_score_array = val['season_performance']['fixture_score_array']
                gw_performance = val['gw_performance']



                $.each(fixture_score_array, function(idx, val) {

                    gw = idx+1
                    console.log(gw_performance[(("0" + gw).slice(-2))])
                        
                    opponent = gw_performance[(("0" + gw).slice(-2))]['fixture_opponent_manager_fullname']

                    temp_obj = {
                        'manager_code': manager_code,
                        'manager_name': manager_name,
                        'team_name': team_name,
                        'fixture_score': val,
                        'opponent': opponent,
                        'gameweek': gw
                    }

                    dataset.push(temp_obj);
                })


            });

            // sort the dataset by score
            sorted_dataset = dataset.slice().sort((a, b) => d3.descending(a.fixture_score, b.fixture_score))

            // Add rank to the dataset
            $.each( sorted_dataset, function(idx, val) {

                if ( idx > 0 ) {
                    if ( sorted_dataset[idx-1]['fixture_score'] === val['fixture_score']) {
                        rank = sorted_dataset[idx-1]['rank']
                    } else {
                        rank = idx+1
                    }
                } else {
                    rank = 1
                }

                this['rank'] = rank

            });

            console.log(sorted_dataset)


            // Add container divs to DOM
            var container_div = $( "#content div.container" );

            var title_block = $("<div />").addClass('title-block')
            .appendTo(container_div);

            var vis_title = $("<h1 />").text("Single scores")
            .appendTo(title_block);

            var vis_subline = $("<p />")
            .appendTo(title_block);


            var viz_div = $("<div />").attr("id", "viz")
            .addClass('large')
            //.addClass('wip')
            .appendTo(container_div);

            var rankings_div = $("<div />").attr("id", "rankings")
            .appendTo(container_div);


            //Build dataviz
            dataviz_config = {
                'viz_height': $( "#viz" ).height(),
                'viz_width': $( "#viz" ).width(),
                'canvas_padding': {
                    'top': 20,
                    'right': 20,
                    'bottom': 25,
                    'left': 25,
                    'inner_top': 20,
                    'inner_right': 0,
                    'inner_bottom': 20,
                    'inner_left': 45
                },
                'xScale': {
                    'domain': (function(){

                        var temp_array = return_as_array(sorted_dataset, 'gameweek');

                        //var domain = return_rounded_extent(d3.extent(temp_array));
                        var domain = d3.extent(temp_array);

                        console.log('x domain')
                        console.log(domain)

                        return domain

                        }) ()
                },
                'yScale': {
                    'domain': (function(){

                        var temp_array = return_as_array(sorted_dataset, 'fixture_score');

                        var domain = return_rounded_extent(d3.extent(temp_array));

                        console.log('y domain')
                        console.log(domain)

                        return domain

                        }) ()
                }
            }

            dataviz_config.xScale.tick_values = (function() {
                // 1, max and every 10
                        var temp_array = [];
                        var domain = dataviz_config.xScale.domain;

                        for (i = domain[0]; i <= domain[1]; i++ ){
                            if (i === domain[0] || i === domain[1] || i % 10 === 0) { 
                                //console.log(i)
                                temp_array.push(i)
                             }
                        }

                        //console.log(temp_array)
                        return temp_array

                    }) ();

            dataviz_config.yScale.tick_values = (function() {
                // Every 25
                        var temp_array = [];
                        var domain = dataviz_config.yScale.domain;

                        for (i = domain[0]; i <= domain[1]; i++){
                            if (i % 25 === 0) { 
                                //console.log(i)
                                temp_array.push(i)
                             }
                        }

                        //console.log(temp_array)
                        return temp_array

                    }) ();

            /*
            var colours_scale = d3.scaleLinear()
            .domain([1, top_scores_dataset.length])
            .range(['#00ff00', '#0000ff'])
            .interpolate(d3.interpolateRgb);
            */

            var viz_container = d3.select("#viz")

            var svg = viz_container.append("svg")
            .attr('height', dataviz_config.viz_height)
            .attr('width', dataviz_config.viz_width);

            //add axes

            //xAxis
            var xScale = d3.scaleLinear()
            .domain(dataviz_config.xScale.domain)
            .range([dataviz_config.canvas_padding.left+dataviz_config.canvas_padding.inner_left, (dataviz_config.viz_width - dataviz_config.canvas_padding.right)]);

            var xAxisGenerator = d3.axisBottom(xScale)
            .tickSizeOuter(0)
            .tickSize(0)
            .tickPadding(10)
            .tickValues(dataviz_config.xScale.tick_values)
            .tickFormat(d => ("GW"+ d));

            var xAxis = svg.append("g")
            .classed("x axis", true)
            .call(xAxisGenerator);

            xAxis.attr('transform', function(d) {
                    return 'translate(0 ' + (dataviz_config.viz_height - dataviz_config.canvas_padding.bottom) + ')';
                });
            
            var xAxisGrid = xAxisGenerator
            .tickSize(dataviz_config.viz_height - dataviz_config.canvas_padding.bottom)
            .tickSizeOuter(0)
            .tickFormat("");

            svg.append("g")
            .attr("class", "axis-grid")
            .call(xAxisGrid)
            .select(".domain").remove();


            //yAxis
            var yScale = d3.scaleLinear()
            .domain(dataviz_config.yScale.domain)
            .range([(dataviz_config.viz_height - dataviz_config.canvas_padding.bottom), dataviz_config.canvas_padding.top]);

            var yAxisGenerator = d3.axisLeft(yScale)
            .tickSizeOuter(0)
            //.tickSize(0)
            .tickPadding(-dataviz_config.canvas_padding.inner_left)
            .tickValues(dataviz_config.yScale.tick_values)
            .tickFormat( function(d) {
                if (d === d3.max(dataviz_config.yScale.tick_values)) {
                    x = d+'pts'
                } else {
                    x = d
                }

                return x
            });



            var yAxis = svg.append("g")
            .classed("y axis", true)
            .call(yAxisGenerator);

            yAxis.select(".domain").remove();


            yAxis.selectAll(".tick text").attr('dy', '-0.4em');


            var yAxisGridGenerator = yAxisGenerator
            .tickSize(-dataviz_config.viz_width)
            .tickSizeOuter(0)
            .tickFormat("");

            yAxisGrid = svg.append("g")
            .attr("class", "axis-grid")
            .call(yAxisGridGenerator);

            yAxisGrid
            .select(".domain").remove();


            //add data
            var data_layer = svg.append('g')
            .classed('data-layer', true)

            var circles = data_layer.selectAll('circle')
            .data(sorted_dataset.slice().sort((a, b) => d3.descending(a.rank, b.rank)))
            .enter()
            .append('circle')
            .attr('cy', function(d) { 
                //console.log(xScale(d.total_score) )
                return yScale(d.fixture_score) 
            })
            .attr('cx', function(d) { 
                //console.log(xScale(d.total_score) )
                return xScale(d.gameweek) 
            })
            .attr('r', 5)
            .style('stroke-width', 1)
            .style('stroke', function(d) {
                rank = d.rank;
                if (rank > 1 && rank <= 5 ) { stroke = "#00ff00"}
                else { stroke = "black"}

                    return stroke
            })
            .style('fill', function(d) {
                rank = d.rank;
                if (rank === 1) { fill = "#00ff00"}
                else if (rank > 1 && rank <= 5 ) { fill = "#000"}
                //else if (rank === sorted_dataset[(sorted_dataset.length-1)].rank) { fill = '#0000ff'}
                else { fill = "rgba(74, 74, 74, 1)"}

                    return fill
            });

            // Add label
            var labels = data_layer.selectAll('text')
            .data(sorted_dataset)
            .enter()
            .filter(function(d) { return d.rank === 1 })
            .append('text')
            .classed('label left-align', true)
            .attr('x', function(d) { return xScale(d.gameweek) })
            .attr('y', function(d) { return yScale(d.fixture_score) })
            .attr('dx', '1em')
            .attr('dy', '-0.5em')
            .text( function(d) { 

                var name = d.manager_name 
                var gameweek = d.gameweek 
                var score = return_comma_formatted_number( d.fixture_score )

                var text = name + ', GW' + gameweek

                return text
            });


            // Build tabulated rankings on page

            var rankings_wrapper = $("<div />")
            .addClass('table-wrapper')
            .appendTo(rankings_div);

            var table_title = $("<h2 />").text('Top 5')
            .appendTo(rankings_wrapper);

            var table_container = $("<div />")
            .addClass('table-container')
            //.addClass('cols-2')
            .appendTo(rankings_wrapper);


            $.each( sorted_dataset, function(idx, val) {

                if ( val.rank <= 5 ){

                    var row = $("<div />").addClass('table-row')
                    .appendTo(table_container)

                    var key_column = $("<div />").addClass('table-column')
                    .addClass('key')
                    .text('•')
                    .css({

                        'color': function() {

                        if (val.rank === 1) {
                            color = '#00ff00'
                        } else { color = 'black'}

                        return color

                        },
                        '-webkit-text-stroke': function() {

                            if (val.rank === 1) {
                            value = 'value'
                            } else { color = '1px #00ff00'}

                        return color
                        }
                    })
                    .appendTo(row)


                    var rank_column = $("<div />").addClass('table-column')
                    .text(function() {  

                        if ( idx > 0 && val['rank'] === sorted_dataset[idx-1]['rank'] ) {
                            //console.log(idx)
                            rank =  "="
                        } else {
                            rank = val['rank']
                        }

                        return rank
                    })
                    .appendTo(row)

                    var manager_name_column = $("<div />").addClass('table-column')
                    .text( function() {

                        text = val['manager_name'] + ', GW' + val['gameweek']

                        return text
                        
                    })
                    .appendTo(row)

/*
                    var gameweek_column = $("<div />").addClass('table-column')
                    .text('GW' + val['gameweek'])
                    .appendTo(row)

                    var opponent_column = $("<div />").addClass('table-column')
                    .text('( vs ' + val['opponent'] + ')')
                    .appendTo(row)
*/
                    var score_column = $("<div />")
                    .addClass('table-column')
                    .addClass('right-align')
                    .text( return_comma_formatted_number(val['fixture_score']) + 'pts')
                    .appendTo(row)


                }



            })

            function return_as_array(source_data, key) {

                temp_array = [];

                //console.log(source_data)
                //console.log(key)

                $.each(source_data, function(idx, val) {
                    temp_array.push(val[key])
                })

                return temp_array
            }

            function return_rounded_extent(input_array) {

                //round-down the min
                input_array[0] = 100 * Math.floor(input_array[0]/100) - 0

                //round-down the min
                input_array[1] = 100 * Math.ceil(input_array[1]/100) + 0

                return input_array            
                    }


            //console.log(top_scores_dataset)
            resize_rows("#rankings")
        }

        function resize_rows(selector) {

                //console.log(selector)

            $( selector ).each( function() {

                //console.log(this)

                cell_width_array = []

                $(this).find( "div.table-row" ).each(function() {

                    $( this ).children().each(  function( idx ) {
                        $(this).removeAttr('width')

                        // if this is the first loop, the array will be shorter than idx+1
                        if (cell_width_array.length < idx+1 ) {
                            // if so, add an array to hold the width vals of 
                            // *all* cells in that idx (same col) across all rowws
                            cell_width_array[idx] = []
                        }

                        // push the width of this cell to the array for this column
                        cell_width = Number($( this ).width())
                        cell_width_array[idx].push(cell_width)

                    })

                });

                //console.log(cell_width_array[1])

                // set each cell's width to the longest in that column
                $(this).find( "div.table-row" ).each(function() {
                    $( this ).children().each(  function(idx) {
                        $(this).width(Math.max(...cell_width_array[idx]));
                    })
                });

            })

        }



    </script>
    
</html>