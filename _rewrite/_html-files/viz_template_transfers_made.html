<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>Title Goes Here</title>
        
        <link rel="stylesheet" type="text/css" href="chump.css">   
        <link rel="stylesheet" type="text/css" href="chump-viz_styles.css">   

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!--<script src="fitty.min.js"></script>-->
        <script src="https://d3js.org/d3.v5.min.js"></script>
       
        <script src="load_database.js"></script>
        
    </head> 
    
    <body> 
        <main>
            <section id="content">
                <div class="divider alt"></div>
                <div class="wrapper dark">
                    <div class="container"></div>
                </div>
                <div class="divider alt"></div>
            </section>
        </main>
    </body> 

    <script>

        function return_comma_formatted_number(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    
        $( function(){
                
            //console.log(database)
            viz_gw_transfers()
                
        });



        function viz_gw_transfers() {

            function return_as_array(source_data, key) {

                temp_array = [];

                //console.log(source_data)
                //console.log(key)

                $.each(source_data, function(idx, val) {
                    temp_array.push(val[key])
                })

                return temp_array
            }

            function return_rounded_extent(input_array) {

                //round-down the min
                input_array[0] = 25 * Math.floor(input_array[0]/25) - 0

                //round-down the min
                input_array[1] = 25 * Math.ceil(input_array[1]/25) + 0

                return input_array            
            }


            // Compile a dataset from the database
            // Total transfers made by gameweek
            dataset = []

            temp_dataset = {}
            var temp_gw_count = []

            //for each player in the database
            $.each( database['player_data'], function(idx, val) {

                manager_code = val['manager_info']['fpl_code'] 

                // take the array of transfers made each week
                transfers_made_array = val['season_performance']['transfers_made_array']
                temp_dataset[manager_code] = transfers_made_array;

                temp_gw_count.push(transfers_made_array.length)


            })


            for (idx=0; idx<d3.max(temp_gw_count); idx++) {

                gw = idx+1
                gameweek = (("0" + gw).slice(-2))

                temp_obj = {
                    'gameweek': parseInt(gameweek),
                    'total': 0
                }

                $.each( temp_dataset, function(key, val) {

                    temp_obj[key] = val[idx]
                    temp_obj['total'] += val[idx]


                })

                dataset.push(temp_obj)

            }

            // sort the dataset by score
            dataset = dataset.slice().sort((a, b) => d3.descending(a.total, b.total))

            // Add rank to the dataset
            $.each( dataset, function(idx, val) {

                if ( idx > 0 ) {
                    if ( dataset[idx-1]['total'] === val['total']) {
                        rank = dataset[idx-1]['rank']
                    } else {
                        rank = idx+1
                    }
                } else {
                    rank = 1
                }

                this['rank'] = rank

            });

            console.log(dataset)


            // Add container divs to DOM
            var container_div = $( "#content div.container" );

            var title_block = $("<div />").addClass('title-block')
            .appendTo(container_div);

            var vis_title = $("<h1 />").text("Transfers made")
            .appendTo(title_block);

            var vis_subline = $("<p />")
            .text("League total, by gameweek")
            .appendTo(title_block);


            var viz_div = $("<div />").attr("id", "viz")
            .addClass('large')
            //.addClass('wip')
            .appendTo(container_div);


            //Build dataviz
            dataviz_config = {
                'viz_height': $( "#viz" ).height(),
                'viz_width': $( "#viz" ).width(),
                'canvas_padding': {
                    'top': 20,
                    'right': 20,
                    'bottom': 35,
                    'left': 25,
                    'inner_top': 20,
                    'inner_right': 0,
                    'inner_bottom': 20,
                    'inner_left': 30
                },
                'xScale': {
                    'domain': (function(){

                        var temp_array = return_as_array(dataset, 'gameweek');

                        //var domain = return_rounded_extent(d3.extent(temp_array));
                        var domain = temp_array.slice().sort((a, b) => d3.ascending(a, b))

                        //console.log('x domain')
                        console.log(domain)

                        return domain

                        }) ()
                },
                'yScale': {
                    'domain': (function(){

                        var temp_array = return_as_array(dataset, 'total');

                        var domain = return_rounded_extent(d3.extent(temp_array));

                        //console.log('y domain')
                        //console.log(domain)

                        return domain

                        }) ()
                },
                'colour_scale': (function(){
                    var colours = d3.scaleLinear()
                    .domain([d3.max(dataset, d => d.rank), 1])
                    //.domain([1, dataset[parseInt(dataset.length)-2].rank])
                    .range(['#0000ff', '#00ff00'])
                    .interpolate(d3.interpolateRgb);

                    return colours

                }) ()
            }

            dataviz_config.xScale.tick_values = (function() {
                // 1, max and every 10
                        var temp_array = [];
                        var domain = dataviz_config.xScale.domain;

                        console.log('domain.length ' + domain.length)

                        for (i = domain[0]; i <= domain.length; i++ ){
                            if (i === domain[0] || i === domain[(parseInt(domain.length)-1)] || i % 10 === 0) { 
                                //console.log(i)
                                temp_array.push(i)
                             }
                        }

                        //console.log(temp_array)
                        return temp_array

                    }) ();

            dataviz_config.yScale.tick_values = (function() {
                // Every 25
                var temp_array = [];
                var domain = dataviz_config.yScale.domain;

                for (i = domain[0]; i <= domain[1]; i++){
                    if (i % 25 === 0) { 
                        //console.log(i)
                        temp_array.push(i)
                     }
                }

                //console.log(temp_array)
                return temp_array

            }) ();


            var viz_container = d3.select("#viz")

            var svg = viz_container.append("svg")
            .attr('height', dataviz_config.viz_height)
            .attr('width', dataviz_config.viz_width);

            //add axes

            //xAxis
            var xScale = d3.scaleBand()
            .domain(dataviz_config.xScale.domain)
            .range([dataviz_config.canvas_padding.left+dataviz_config.canvas_padding.inner_left, (dataviz_config.viz_width - dataviz_config.canvas_padding.right)])
            .paddingInner(0.25);

            var xAxisGenerator = d3.axisBottom(xScale)
            .tickSizeOuter(0)
            .tickSize(10)
            .tickPadding(10)
            .tickValues(dataviz_config.xScale.tick_values)
            .tickFormat(d => ("GW"+ d));

            var xAxis = svg.append("g")
            .classed("x axis", true)
            .call(xAxisGenerator);

            xAxis.select(".domain").remove();
            xAxis.attr('transform', function(d) {
                    return 'translate(0 ' + (dataviz_config.viz_height - dataviz_config.canvas_padding.bottom) + ')';
                });
            
            var xAxisGrid = xAxisGenerator
            .tickSize(dataviz_config.viz_height - dataviz_config.canvas_padding.bottom)
            .tickSizeOuter(0)
            .tickFormat("");

            svg.append("g")
            .attr("class", "axis-grid")
            .call(xAxisGrid)
            .select(".domain").remove();


            //yAxis
            var yScale = d3.scaleLinear()
            .domain(dataviz_config.yScale.domain)
            .range([(dataviz_config.viz_height - dataviz_config.canvas_padding.bottom), dataviz_config.canvas_padding.top]);

            var yAxisGenerator = d3.axisLeft(yScale)
            .tickSizeOuter(0)
            //.tickSize(0)
            .tickPadding(-dataviz_config.canvas_padding.inner_left)
            .tickValues(dataviz_config.yScale.tick_values);



            var yAxis = svg.append("g")
            .classed("y axis", true)
            .call(yAxisGenerator);

            yAxis.select(".domain").remove();
            yAxis.selectAll(".tick text").attr('dy', '-0.4em');


            var yAxisGridGenerator = yAxisGenerator
            .tickSize(-dataviz_config.viz_width)
            .tickSizeOuter(0)
            .tickFormat("");

            yAxisGrid = svg.append("g")
            .attr("class", "axis-grid")
            .call(yAxisGridGenerator);

            yAxisGrid
            .select(".domain").remove();


            //add data
            var data_layer = svg.append('g')
            .classed('data-layer', true)

            var bars = data_layer.selectAll('.bar')
            .data(dataset)
            .enter()
            .append('rect')
            .classed('bar', true)
            .attr("y", function(d) { return yScale(d.total); })
            .attr("height", function(d) { return yScale(0) - yScale(d.total); })
            .attr("x", function(d) { return xScale(d.gameweek); })
            .attr("width", xScale.bandwidth())
            .style('fill', function(d) { 

                if (d.rank === 1 ){
                    fill = dataviz_config.colour_scale(d.rank)
                } else if (d.rank === d3.max(dataset.filter(function(d) { return d.gameweek > 1 }), d => d.rank )) {
                    fill = dataviz_config.colour_scale(d.rank)
                }  else {
                    fill = 'rgb(74, 74, 74)'
                }

                return fill

            });


            // Build tabulated rankings on page
            var rankings_div = $("<div />").attr("id", "rankings")
            .appendTo(container_div);


            var columns_wrapper = $("<div />")
            .addClass('column-wrapper cols-2')
            .appendTo(rankings_div);

            var top_rankings_container = $("<div />")
            .addClass('column-container')
            .appendTo(columns_wrapper);

            var top_table_title = $("<h2 />").text('Top 5')
            .appendTo(top_rankings_container);

            var top_table_container = $("<div />")
            .addClass('table-container')
            //.addClass('cols-2')
            .appendTo(top_rankings_container);


            var bottom_rankings_container = $("<div />")
            .addClass('column-container')
            .appendTo(columns_wrapper);

            var bottom_table_title = $("<h2 />").text('Bottom 5')
            .appendTo(bottom_rankings_container);

            var bottom_table_container = $("<div />")
            .addClass('table-container')
            //.addClass('cols-2')
            .appendTo(bottom_rankings_container);


            $.each( dataset.filter(function(d) { return d.gameweek > 1 }), function(idx, val) {

                if ( val.rank <= 5 ){

                    var row = $("<div />").addClass('table-row')
                    .appendTo(top_table_container)

                } else if ( val.rank >= (d3.max(dataset, d => d.rank ) - 5))  {

                    var row = $("<div />").addClass('table-row')
                    .appendTo(bottom_table_container)
                }

                    var key_column = $("<div />").addClass('table-column')
                    .addClass('key')
                    .text('•')
                    .css({

                        'color': function() {

                        if (val.rank === 1 || val.rank === d3.max(dataset.filter(function(d) { return d.gameweek > 1 }),d => d.rank))  {

                            color = dataviz_config.colour_scale(val.rank)

                        } else { color = 'transparent'}

                        return color

                        }
                    })
                    .appendTo(row)


                    var rank_column = $("<div />").addClass('table-column')
                    .text(function() {  

                        if ( idx > 0 && val['rank'] === dataset[idx-1]['rank'] ) {
                            //console.log(idx)
                            rank =  "="
                        } else {
                            rank = val['rank']
                        }

                        return rank
                    })
                    .appendTo(row)

                    var gameweek_column = $("<div />").addClass('table-column')
                    .text( function() {

                        text = 'GW' + val['gameweek']

                        return text
                        
                    })
                    .appendTo(row)

                    var score_column = $("<div />")
                    .addClass('table-column')
                    .addClass('right-align')
                    .text( return_comma_formatted_number(val['total']))
                    .appendTo(row)


            })

            resize_rows("#rankings")

        }

        function resize_rows(selector) {

                //console.log(selector)

            $( selector ).each( function() {

                //console.log(this)

                cell_width_array = []

                $(this).find( "div.table-row" ).each(function() {

                    $( this ).children().each(  function( idx ) {
                        $(this).removeAttr('width')

                        // if this is the first loop, the array will be shorter than idx+1
                        if (cell_width_array.length < idx+1 ) {
                            // if so, add an array to hold the width vals of 
                            // *all* cells in that idx (same col) across all rowws
                            cell_width_array[idx] = []
                        }

                        // push the width of this cell to the array for this column
                        cell_width = Number($( this ).width())
                        cell_width_array[idx].push(cell_width)

                    })

                });

                //console.log(cell_width_array[1])

                // set each cell's width to the longest in that column
                $(this).find( "div.table-row" ).each(function() {
                    $( this ).children().each(  function(idx) {
                        $(this).width(Math.max(...cell_width_array[idx]));
                    })
                });

            })

        }

            


    </script>
    
</html>