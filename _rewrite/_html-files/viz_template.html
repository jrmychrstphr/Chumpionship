<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 

<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>Title Goes Here</title>
        
        <link rel="stylesheet" type="text/css" href="chump.css">   
        <link rel="stylesheet" type="text/css" href="chump-viz_styles.css">   

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!--<script src="fitty.min.js"></script>-->
        <script src="https://d3js.org/d3.v5.min.js"></script>
       
        <script src="load_database.js"></script>
        
    </head> 
    
    <body> 
        <main>
            <section id="content">
                <div class="divider alt"></div>
                <div class="wrapper dark">
                    <div class="container"></div>
                </div>
                <div class="divider alt"></div>
            </section>
        </main>
    </body> 

    <script>

        function return_comma_formatted_number(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    
        $( function(){
                
            //console.log(database)
            viz_total_scores()
                
        });

        function viz_total_scores(gameweek, single_mode) {

            if ( single_mode && single_mode.toLowerCase() == 'true' ){
                single_mode = true
            } else {
                single_mode = false
            }


            // Compile a dataset from the database
            top_scores_dataset = []

            $.each( database['player_data'], function() {

                manager_code = this['manager_info']['fpl_code'] 
                    manager_name = this['manager_info']['manager_fullname'] 
                    team_name = this['manager_info']['team_name'] 

                if (gameweek) {

                    gw_idx = parseInt(gameweek) - 1

                    if (single_mode) {
                        total_score = this['season_performance']['fixture_score_array'][gw_idx]
                    } else {
                        total_score = this['season_performance']['fixture_score_running_total_array'][gw_idx]
                    }


                } else {

                    total_score = this['season_performance']['fixture_score_total']

                }

                temp_obj = {
                    'manager_code': manager_code,
                    'manager_name': manager_name,
                    'team_name': team_name,
                    'total_score': total_score
                }

                top_scores_dataset.push(temp_obj)

            });

            top_scores_dataset.sort(function(a, b) {
                return b.total_score - a.total_score 
            })

            // Add rank to the dataset
            $.each( top_scores_dataset, function(idx, val) {

                if ( idx > 0 ) {
                    if ( top_scores_dataset[idx-1]['total_score'] === this['total_score']) {
                        rank = top_scores_dataset[idx-1]['rank']
                    } else {
                        rank = idx+1
                    }
                } else {
                    rank = 1
                }

                this['rank'] = rank

            });

            // Add container divs to DOM
            var container_div = $( "#content div.container" );

            var title_block = $("<div />").addClass('title-block')
            .appendTo(container_div);

            var vis_title = $("<h1 />").text("Overall score")
            .appendTo(title_block);

            var vis_subline = $("<p />")
            .appendTo(title_block);

            if (gameweek) {
                if (single_mode){ text = 'GW'+gameweek }
                else { text = 'GW1–GW'+gameweek }
                
                vis_subline.text(text)
            }

            var viz_div = $("<div />").attr("id", "viz")
            .appendTo(container_div);

            var rankings_div = $("<div />").attr("id", "rankings")
            .appendTo(container_div);


            //Build dataviz
            dataviz_config = {
                'viz_height': $( "#viz" ).height(),
                'viz_width': $( "#viz" ).width(),
                'canvas_padding': {
                    'top': 0,
                    'right': 20,
                    'bottom': 25,
                    'left': 20
                },
                'xScale': {
                    'domain': (function(){

                        var temp_array = return_as_array(top_scores_dataset, 'total_score');

                        var domain = return_rounded_extent(d3.extent(temp_array));

                        //console.log(domain)

                        return domain

                        }) ()
                }
            }

            dataviz_config.xScale.tick_values = (function() {

                        var temp_array = [];
                        var domain = dataviz_config.xScale.domain;

                        for (i = domain[0]; i <= domain[1]; i++ ){
                            if (i % 100 === 0) { 
                                //console.log(i)
                                temp_array.push(i)
                             }
                        }

                        //console.log(temp_array)

                        return temp_array

                    }) ();

            var colours_scale = d3.scaleLinear()
            .domain([1, top_scores_dataset.length])
            .range(['#00ff00', '#0000ff'])
            .interpolate(d3.interpolateRgb);

            var viz_container = d3.select("#viz")

            var svg = viz_container.append("svg")
            .attr('height', dataviz_config.viz_height)
            .attr('width', dataviz_config.viz_width);

            var xScale = d3.scaleLinear()
            .domain(dataviz_config.xScale.domain)
            .range([dataviz_config.canvas_padding.left, (dataviz_config.viz_width - dataviz_config.canvas_padding.right)]);

            var xAxis = d3.axisBottom(xScale)
            .tickSizeOuter(0)
            .tickSize(0)
            .tickValues(dataviz_config.xScale.tick_values);

            svg.append("g")
            .attr("class", "axis")
            .call(xAxis)
            .attr('transform', function(d) {
                    return 'translate(0 ' + (dataviz_config.viz_height - dataviz_config.canvas_padding.bottom) + ')';
                })
            .select(".domain").remove();

            var xAxisGrid = xAxis
            .tickSize(dataviz_config.viz_height - dataviz_config.canvas_padding.bottom)
            .tickSizeOuter(0)
            .tickFormat("");

            svg.append("g")
            .attr("class", "axis-grid")
            .call(xAxisGrid)
            .select(".domain").remove();

            var data_layer = svg.append('g')
            .classed('data-layer', true)

            var circles = data_layer.selectAll('circle')
            .data(top_scores_dataset.slice().sort((a, b) => d3.descending(a.rank, b.rank)))
            .enter()
            .append('circle')
            .attr('cx', function(d) { 
                //console.log(xScale(d.total_score) )
                return xScale(d.total_score) 
            })
            .attr('cy', 100)
            .attr('r', function(d) {

                if ( d.rank === 1 ) {
                    radius = 10
                } else { radius = 5 }

                return radius

            })
            .style('stroke-width', 1)
            .style('stroke', function(d) {
                rank = d.rank;
                if (rank === 1) { stroke = "black"}
                else if (rank === 20) { stroke = "black"}
                else { stroke = "black"}

                    return stroke
            })
            .style('fill', function(d) { return colours_scale(d.rank)});

            // Add label
            var labels = data_layer.selectAll('text')
            .data(top_scores_dataset)
            .enter()
            .filter(function(d) { return d.rank === 1 })
            .append('text')
            .classed('label', true)
            .attr('x', function(d) { return xScale(d.total_score) })
            .attr('y', 80)
            .text( function(d) { 

                var name = d.manager_name 
                var score = return_comma_formatted_number( d.total_score )

                var text = name + ': ' + score

                return name
            });


            // Build tabulated rankings on page

            var rankings_wrapper = $("<div />").addClass('table-wrapper')
            .appendTo(rankings_div);

            var table_title = $("<h2 />").text('Rankings')
            .appendTo(rankings_wrapper);

            var table_container = $("<div />").addClass('table-container')
            .appendTo(rankings_wrapper);


            $.each( top_scores_dataset, function(idx, val) {


                var row = $("<div />").addClass('table-row')
                .appendTo(table_container)

                var key_column = $("<div />").addClass('table-column')
                .addClass('key')
                .text('•')
                .css('color', function() { 
                    //console.log(val['rank'])
                    //console.log(colours_scale(val['rank']))
                    return colours_scale(val['rank'])
                })
                .appendTo(row)


                var rank_column = $("<div />").addClass('table-column')
                .text(function() {  

                    if ( idx > 0 && val['rank'] === top_scores_dataset[idx-1]['rank'] ) {
                        //console.log(idx)
                        rank =  "="
                    } else {
                        rank = val['rank']
                    }

                    return rank
                })
                .appendTo(row)

                var manager_name_column = $("<div />").addClass('table-column')
                .text( function() {

                    if (val['rank'] === 1 ){
                        text = val['manager_name'] + ' (£)'
                    } else { text = val['manager_name'] }

                    return text
                    
                })
                .appendTo(row)

                /*
                var team_name_column = $("<div />").addClass('table-column')
                .text(this['team_name'])
                .appendTo(row)
                */

                var score_column = $("<div />").addClass('table-column')
                .text( return_comma_formatted_number(this['total_score']) )
                .appendTo(row)


            })

            function return_as_array(source_data, key) {

                temp_array = [];

                //console.log(source_data)
                //console.log(key)

                $.each(source_data, function(idx, val) {
                    temp_array.push(val[key])
                })

                return temp_array
            }

            function return_rounded_extent(input_array) {

                //round-down the min
                input_array[0] = 100 * Math.floor(input_array[0]/100) - 0

                //round-down the min
                input_array[1] = 100 * Math.ceil(input_array[1]/100) + 0

                return input_array            
                    }


            //console.log(top_scores_dataset)
            resize_rows("#rankings")
        }

        function resize_rows(selector) {

                //console.log(selector)

            $( selector ).each( function() {

                //console.log(this)

                cell_width_array = []

                $(this).find( "div.table-row" ).each(function() {

                    $( this ).children().each(  function( idx ) {
                        $(this).removeAttr('width')

                        // if this is the first loop, the array will be shorter than idx+1
                        if (cell_width_array.length < idx+1 ) {
                            // if so, add an array to hold the width vals of 
                            // *all* cells in that idx (same col) across all rowws
                            cell_width_array[idx] = []
                        }

                        // push the width of this cell to the array for this column
                        cell_width = Number($( this ).width())
                        cell_width_array[idx].push(cell_width)

                    })

                });

                //console.log(cell_width_array[1])

                // set each cell's width to the longest in that column
                $(this).find( "div.table-row" ).each(function() {
                    $( this ).children().each(  function(idx) {
                        $(this).width(Math.max(...cell_width_array[idx]));
                    })
                });

            })

        }



    </script>
    
</html>